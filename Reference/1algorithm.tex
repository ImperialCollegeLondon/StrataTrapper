
\begin{algorithm}[H]
  \SetKwInOut{Input}{Input }\SetKwInOut{Output}{Output }
  \SetAlgoLined
    \Input{
      The fluid properties in \textit{Fluid\_transport\_properties.mat} \\
      The structure and petrophysical properties in \textit{A\_input.txt} \\
      The specific relations from report stored in \textit{A\_input\_report.m} \\
      }
    \Output{The upscalled model for simulation}

    Load reservoir \& petrophysical properties. Define upscaling, and do the interpolation. \textit{A1\_1\_Generate\_global\_parameters .m}\\

      Generate the correlated porosity field (Figure. \ref{porosity}) in the fine-scale grid, which is utilized to calculate the  permeability distribution (Figure. \ref{Permeability}), as well as derive the entry capillary pressure field (Figure. \ref{Pe}) using the Leverett-J function. \textit{A2\_1\_Gene\_data\_stru\_fine.m}\\

      Polygon transect fitting to reveal on-site geo-structure. \textit{A2\_1\_Gene\_shift\_structure\_fine2.m}

      Construct the data structure and calculate the porosity distribution in the upscaled gid (Figure. \ref{porosity2}). \textit{A2\_2\_Generate\_data\_structure\_upscaled.m}\\

     \For{$k\ \in\ all\ coarse\ cells$}
     {
     \For{$i = 1\cdots n$ (All aimed saturation points)}{
     Calculate capillary pressure ($P_c$) at $S_{w,aim}$ using the Brooks-Corey equation with average entry pressure in the coarse cell. Set $P_c$ as the initial guess for the macroscopic boundary pressure, $P_b$. And define an initial $S_w$.\\

      \While {$(S^i_{w,aim} - S_w) > E_{thresh} $}
      {
      Perform Macroscopic Invasion Percolation (MIP): the local system is invaded with non-wetting phase at $P_b$ starting from the boundary cells and working inwards. A fine-scale cell is invaded if 1) it is connected to a cell which is connected to the boundary and 2) $P_b$ is greater than the cell's entry pressure.\\

      Once all accessible cells are invaded, calculate the upscaled $S_w$ (the fine-scale saturation distribution is inverted from the fine-scale capillary pressure distribution. The upscaled saturation is volume averaging one). \\

      Update $P_b$ based on the updated $S_w$.

      }

      %Assuming capillary equilibrium, the macroscopic capillary pressure can then be calculated  through the difference in intrinsic phase averages.
      The fine-scale relative permeability distribution is calculated using the known fine-scale saturation. \textit{A3\_1\_Perform\_MIP\_upscaling.m} \\
      }

      %Calculate the macroscopic, anisotropic relative permeability:
      Analytically calculate permeability in each direction using the fine-scale system at each saturation point. \textit{A4\_1.m}

      %Generate CMG files to simulate single-phase injection.\textit{A4\_1\_Generate\_single\_phase\_files.m}
      %{\color{red} Simulate single-phase injection. \textit{A4\_2\_Run\_single\_phase\_files\_test.m } (\textbf{6 hours, 750 cells})}

      The macroscopic relative permeability at each phase saturation is calculated with Darcy's Law. The data points are subsequently fitted with a functional form. \textit{A4\_3\_Post\_process\_single\_phase\_files.m}\\


      }
      \caption{Pore to Core to Field Scale Upscaling}
      \label{Pore2Core}
  \end{algorithm}


   %Perform Macroscopic Invasion Percolation (MIP) to obtain the upscaled capillary pressure at decreasing water saturations $S_{w,aim}$: Calculate the capillary pressure, $P_c$ using the Brooks-Corey equation at each $S_{w,aim}$, using the average entry pressure in the coarse cell. $S_{w,aim}$ is obtained by splitting the saturation range into 40 equal increments, starting from $S_w = 1$. Use $P_c$ as the initial guess for the macroscopic boundary pressure, $P_b$. The local system is invaded with non-wetting phase at the applied $P_b$ starting from the boundary cells and working inwards. A fine-scale cell is invaded if 1) it is connected to a cell which is connected to the boundary and 2) $P_b$ is greater than the cell's entry pressure. Once all accessible cells are invaded, calculate the upscaled $S_w$ (the fine-scale saturation distribution is inverted from the fine-scale capillary pressure distribution. The upscaled saturation is then calculated via volume averaging). \textit{A3\_1\_Perform\_MIP\_upscaling.m} \\
      %If the error between $S_{w,aim}$ and $S_w $ is beyond a certain threshold, $P_b$ is updated using a Newton-Raphson iteration. MIP is then repeated using the new $P_b$. This is done until convergence.\\
